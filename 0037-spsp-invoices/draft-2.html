<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Payments across payment networks">

    <title>SPSP Invoices | Interledger</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles -->
    <link href="/css/monokai-sublime.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,600,700|Droid+Sans+Mono|Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>

    <!-- Font awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css">

    <link href="/assets/favicon.ico" rel="icon" type="image/x-icon">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body data-spy="scroll" data-target="#myScrollspy" data-offset="160" class="spec">

     <!-- navbar -->
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img class="logo" alt="interledger" src="/assets/ilp_icon.png"/></a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="/overview.html">Docs</a></li>
              <li><a href="/community.html">Community</a></li>
              <li><a href="/news.html">News</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a target="_blank" href="https://github.com/interledger">Github</a></li>
            </ul>
          </div>
        </div>
      </nav>

    <!-- docs overview section -->

    <div class="container docs-wrapper">
      <div class="row">
        <div id="sidebarContent">
          <nav class="col-sm-4" id="myScrollspy">
            <ul class="nav-fixed nav nav-sidebar">
              <div class="overview-back"><a href="/overview.html"><i class="fa fa-angle-double-left" aria-hidden="true"></i> Back to Overview</a></div>
                <li class="nav-label">
                  <a href="./draft-2.html">ILP-RFC 0037 Draft 2</a>
                </li>
                <li>
                  <a href="./draft-2.html">Permalink to this Draft</a>
                </li>
                <li>
                  <a href="./">View the Latest Draft of ILP-RFC 0037</a>
                </li>
              
                <li class="nav-label">
                  <a href="#preface">Preface</a>
                </li>
              
                <li class="nav-label">
                  <a href="#introduction">Introduction</a>
                </li>
              
                <li>
                  <a href="#invoice-payments">Invoice Payments</a>
                </li>
              
                <li>
                  <a href="#motivation">Motivation</a>
                </li>
              
                <li>
                  <a href="#scope">Scope</a>
                </li>
              
                <li>
                  <a href="#definitions">Definitions</a>
                </li>
              
                <li>
                  <a href="#operation-overview">Operation Overview</a>
                </li>
              
                <li class="nav-label">
                  <a href="#model-of-operation">Model of Operation</a>
                </li>
              
                <li>
                  <a href="#creating-an-invoice-payment-pointer">Creating an Invoice Payment Pointer</a>
                </li>
              
                <li>
                  <a href="#conducting-an-invoice-payment">Conducting an Invoice Payment</a>
                </li>
              
                <li class="nav-label">
                  <a href="#specification">Specification</a>
                </li>
              
                <li>
                  <a href="#query-get-spsp-endpoint">Query (GET &lt;SPSP Endpoint&gt;)</a>
                </li>
              
            </ul>
          </nav>
        </div>
        <div class="col-sm-8 markdown-body">
                      <h1 id="spsp-invoices">SPSP Invoices</h1>
<h2 id="preface">Preface</h2>
<p class="intro">This document describes how conduct an Invoice Payment via <a href="../0029-stream">STREAM</a> once the payment details have been exchanged via the <a href="../0009-simple-payment-setup-protocol">Simple Payment Setup Protocol</a> (SPSP).</p>
<h2 id="introduction">Introduction</h2>
<h3 id="invoice-payments">Invoice Payments</h3>
<p>An Invoice Payment is a push payment to an Invoice SPSP Endpoint that allows the Payer (sender) to settle outstanding balances with the Payee (receiver). The Invoice SPSP Endpoint MAY expose the details about the Invoice and, when receiving value, updates its outstanding balance accordingly.</p>
<h3 id="motivation">Motivation</h3>
<p>The <a href="../0009-simple-payment-setup-protocol">Simple Payment Setup Protocol</a> (SPSP) only describes how the details required for a STREAM connection are exchanged and how simple push payments are made. Invoices require the SPSP server to keep track of incoming payments, i.e. act as an accounting server. </p>
<h3 id="scope">Scope</h3>
<p>This document specifies Invoice specific endpoints on SPSP and payments to these. They are intended for wallet providers and merchants.</p>
<h3 id="definitions">Definitions</h3>
<ul>
<li><strong>Invoice</strong> - A set of parameters describing the nature of the value transfer as well as its terms and status.</li>
<li><strong>Invoice Payment</strong> - The process of completing an Invoice by transferring value to its corresponding Invoice SPSP Endpoint.</li>
<li><strong>Payer</strong> - The entity that is sending units of value to an Invoice SPSP Endpoint on the Payee&apos;s <a href="../0009-simple-payment-setup-protocol#Definitions">SPSP Server</a>. It is running the <a href="../0009-simple-payment-setup-protocol#Definitions">SPSP Client</a>.</li>
<li><strong>Payee</strong> - The entity that is creating an Invoice SPSP Endpoint and receives units of value from the Payer using this Invoice SPSP Endpoint. It is running the <a href="../0009-simple-payment-setup-protocol#Definitions">SPSP Server</a>.</li>
<li><strong>Invoice Payment Pointer</strong> - A <a href="../0026-payment-pointers">Payment Pointer</a> that includes a unique and opaque string and represents an Invoice. The SPSP Client uses it to query the <a href="../0009-simple-payment-setup-protocol#Definitions">SPSP Endpoint</a> on the SPSP Server, which MAY expose the details of the Invoice. It is the means by which the Payee keeps track of incoming payments. </li>
</ul>
<h3 id="operation-overview">Operation Overview</h3>
<p>The Payer&apos;s SPSP Client will set up a <a href="../0029-stream">STREAM</a> connection to the Payee&apos;s SPSP Server using the Invoice Payment Pointer, as described by the <a href="../0009-simple-payment-setup-protocol">Simple Payment Setup Protocol</a>. On connection, the SPSP Client pushes as much value to the SPSP Server as necessary to complete the Invoice.</p>
<h2 id="model-of-operation">Model of Operation</h2>
<h3 id="creating-an-invoice-payment-pointer">Creating an Invoice Payment Pointer</h3>
<p>Prior to the Invoice Payment, the Payee has to create the Invoice Payment Pointer representing the Invoice. This Invoice Payment Pointer MUST be unique to the Invoice. The Payee&apos;s SPSP Server SHOULD store the Invoice details associated to the Invoice Payment Pointer, which are defined in the <code>invoice</code>-object within the <a href="#Response-Body">Response Body</a>, in order to account for balance changes.</p>
<h3 id="conducting-an-invoice-payment">Conducting an Invoice Payment</h3>
<p>The Payer&apos;s SPSP Client opens a <a href="../0029-stream">STREAM</a> connection to the Payee&apos;s SPSP Server as described in the <a href="../0009-simple-payment-setup-protocol">Simple Payment Setup Protocol</a>. Once this connection is established, the process continues as follows: </p>
<p>The SPSP Client begins sending ILP packets using the STREAM protocol to complete the Invoice.</p>
<ol>
<li>The SPSP Client will adjust their <code>sendMax</code> to reflect the amount they&apos;re willing to send.<ul>
<li><code>sendMax</code> SHOULD be derived from the Invoice, i.e., <code>sendMax</code> SHOULD be equal to <code>push.invoice.amount - push.balance</code>, converted to the SPSP Client&apos;s operating asset, plus a buffer to take exchange rate fluctuations and connector fees into account.</li>
</ul>
</li>
<li>The SPSP Server will adjust their <code>receiveMax</code> to reflect the amount they&apos;re willing to receive.<ul>
<li><code>receiveMax</code> SHOULD be derived from the Invoice, i.e., <code>sendMax</code> SHOULD be equal to <code>push.invoice.amount - push.balance</code>, converted to the SPSP Server&apos;s operating asset, plus a buffer to take exchange rate fluctuations into account.</li>
</ul>
</li>
<li>The SPSP Client&apos;s and Server&apos;s <a href="../0009-simple-payment-setup-protocol#Definitions">STREAM Modules</a> will move as much value as possible while staying inside these bounds.</li>
<li>If the SPSP Client reaches their <code>sendMax</code>, they end the stream and the connection. If the SPSP Server reaches their <code>receiveMax</code>, they will end the stream and the connection. Furthermore, when the SPSP Server has received enough value to fully pay the invoice, it ends the stream and the connection. In both cases, the connection is closed with a <code>NoError</code> code in the <code>ConnectionClose</code> frame.</li>
</ol>
<p>The STREAM parameters--<code>sendMax</code> and <code>receiveMax</code>--as well as the <code>ConnectionClose</code> frame are defined in <a href="../0029-stream#53-frames">STREAM&apos;s frame encoding</a>.</p>
<h2 id="specification">Specification</h2>
<h3 id="query-get-spsp-endpoint">Query (<code>GET &lt;SPSP Endpoint&gt;</code>)</h3>
<p>The SPSP Client queries the Invoice Payment Pointer to get information about the SPSP Server as well as Invoice specific details:</p>
<h4 id="request">Request</h4>
<pre><code class="lang-http">GET /invoice123 HTTP/1.1
Host: example.com
Accept: application/spsp4+json
</code></pre>
<h4 id="response">Response</h4>
<pre><code class="lang-http">HTTP/1.1 200 OK
Content-Type: application/spsp4+json

{
  &quot;destination_account&quot;: &quot;example.ilpdemo.red.invoice123&quot;,
  &quot;shared_secret&quot;: &quot;6jR5iNIVRvqeasJeCty6C+YB5X9FhSOUPCL/5nha5Vs=&quot;,
  &quot;push&quot;: {
    &quot;balance&quot;: &quot;5360&quot;,
    &quot;invoice&quot;: {
      &quot;amount&quot;: &quot;19999&quot;,
      &quot;asset&quot;: {
        &quot;code&quot;: &quot;USD&quot;,
        &quot;scale&quot;: 2
      },
      &quot;additional_fields&quot;: {
        &quot;description&quot;: &quot;Chair model &apos;Rustic&apos;&quot;,
        &quot;receiver&quot;: &quot;The Red Furniture Store&quot;
      }
    }
  }
}
</code></pre>
<h5 id="response-body">Response Body</h5>
<p>The response body is a JSON object that includes basic account details necessary for setting up a STREAM connection as well as optional parameters for displaying purposes. The fields are defined in the following: </p>
<table class="table table-striped">
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>destination_account</code></td>
<td><a href="../0015-ilp-addresses">ILP Address</a></td>
<td>(see <a href="../0009-simple-payment-setup-protocol#Response-Body">Simple Payment Setup Protocol</a>)</td>
</tr>
<tr>
<td><code>shared_secret</code></td>
<td>32 bytes, <a href="https://en.wikipedia.org/wiki/Base64">base64 encoded</a> (including padding)</td>
<td>(see <a href="../0009-simple-payment-setup-protocol#Response-Body">Simple Payment Setup Protocol</a>)</td>
</tr>
<tr>
<td><code>push</code></td>
<td>Object</td>
<td>Details of this specific push payment pointer.</td>
</tr>
<tr>
<td><code>push.balance</code></td>
<td>String Integer</td>
<td>Amount, denoted in <code>push.invoice.asset.code</code>, which completes the invoice payment.</td>
</tr>
<tr>
<td><code>push.invoice</code></td>
<td>Object</td>
<td>Invoice details.</td>
</tr>
<tr>
<td><code>push.invoice.amount</code></td>
<td>String Integer</td>
<td>Amount, denoted in <code>push.invoice.asset.code</code>, which needs to be received in order for the invoice to be considered as paid.</td>
</tr>
<tr>
<td><code>push.invoice.asset</code></td>
<td>Object</td>
<td>Details about the Invoice&apos;s asset.</td>
</tr>
<tr>
<td><code>push.invoice.asset.code</code></td>
<td>String</td>
<td>Asset code to identify the Invoice&apos;s currency. Currencies that have <a href="https://en.wikipedia.org/wiki/ISO_4217">ISO 4217</a> codes should use those.</td>
</tr>
<tr>
<td><code>push.invoice.asset.scale</code></td>
<td>Integer</td>
<td>The scale of the amounts denoted in <code>push.invoice.asset.code</code> (e.g. an amount of <code>&quot;1000&quot;</code> with a scale of <code>2</code> translates to <code>10.00</code> units of the SPSP server&apos;s asset/currency).</td>
</tr>
<tr>
<td><code>push.invoice.additional_fields</code></td>
<td>Object</td>
<td><em>(OPTIONAL)</em> Any additional information the Payee wants to include.</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> Currency amounts are denominated as integer strings instead of native JSON numbers to avoid losing precision during JSON parsing. Applications MUST represent these numbers in a data type that has precision equal or greater than an unsigned 64-bit integer.</p>
<h5 id="errors">Errors</h5>
<h6 id="pointer-does-not-exist">pointer Does Not Exist</h6>
<pre><code class="lang-http">HTTP/1.1 404 Not Found
Content-Type: application/spsp4+json

{
  &quot;id&quot;: &quot;InvalidPointerError&quot;,
  &quot;message&quot;: &quot;Pointer does not exist.&quot;
}
</code></pre>

        </div>
      </div>

    </div> <!-- /container -->

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="col-sm-4 col-xs-12">
              <p>Copyright Â© 2018<br/> W3C Interledger Payments CG</p>
            </div>
            <div class="col-sm-4 col-xs-12">
              <p class="text-center">See list of <a target="_blank" href="https://www.w3.org/community/interledger/participants">Contributors</a></p>
            </div>
            <div class="col-sm-4 col-xs-12">
              <p class="pull-right">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68500608-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
